{% extends "layout.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
<link rel="stylesheet" href="static/overridestyle.css" />
<script>
    $(document).ready(function () {
        $('.ui.search.dropdown').dropdown();
        $(" #try_your_luck").click(function () {
            $("#trade-form").modal();
        });
        $("#c2b").on('change', function () {
            $("#c2sDrop> div").slice(0).remove();
            var cointobuy = $("#c2b").dropdown('get value');
            $.ajax({
                url: "/limit-dropdown",
                type: "GET",
                data: {
                    c2b: cointobuy,
                },
                success: function (response) {
                    // populate fields in second dropdown based on available trading pairs
                    var dropMenu = document.querySelector("#c2sDrop");
                    var iconList = "{{svg_icons}}";
                    var responseSorted = $.map(response, function (value, index) {
                        return [value].sort();
                    });
                    for (val of responseSorted) {
                        var option = document.createElement("div");
                        option.value = val;
                        option.text = val;
                        option.innerHTML = val;
                        option.className = "item";
                        option.dataset.value = val;
                        var image = document.createElement("IMG");
                        image.alt = "$$$";
                        if (iconList.includes(val)) {
                            image.src = "/static/icons/" + val + ".svg";
                        } else {
                            image.src = "/static/icons/generic.svg"
                        };
                        image.width = 20;
                        image.height = 20;
                        option.prepend(image);
                        dropMenu.appendChild(option);
                    }
                },
                error: function (xhr) {
                    console.log(xhr.responseText)
                }
            });
        });
        $('.ui.form')
            .form({
                on: "blur",
                fields: {
                    coin_to_buy: {
                        identifier: 'c2b',
                        rules: [
                            {
                                type: 'empty',
                                prompt: 'Please enter a coin to buy'
                            }
                        ]
                    },
                    coin_to_sell: {
                        identifier: 'c2s',
                        rules: [
                            {
                                type: 'empty',
                                prompt: 'Please enter a coin to sell'
                            }
                        ]
                    },
                    amount: {
                        identifier: 'a2s',
                        rules: [
                            {
                                type: 'decimal',
                                prompt: 'Please enter the amount you would like to sell'
                            }
                        ]
                    }
                },
                on: 'blur',
                inline: true,
                onSuccess: function (event) {
                    var coin_to_buy = $("#c2b").dropdown('get value');
                    var coin_to_sell = $("#c2s").dropdown('get value');
                    var amount = $("#amount").val();
                    var dataObject = JSON.stringify({
                        'base_asset': coin_to_buy,
                        'quote_asset': coin_to_sell,
                        'user_amount': amount,
                    });
                    TradeSubmit(dataObject)
                    setTimeout(() => { TradeGet() }, 1000);
                    event.preventDefault();
                },
            });
        function openModal() {
            $("#trade-form").modal({ fadeDuration: 400 });
        };
        function TradeSubmit(dataObject) {
            $.ajax({
                url: "/gain-or-pain",
                type: "POST",
                contentType: "application/json",
                data: dataObject,
                datatype: "json"
            });
        };
        function TradeGet() {
            $.get("/trade-db", function (data) {
                $("#dollar-result").data("dollars", { WorL: parseFloat(data['gain_or_pain_in_dollars']), total_dollar: parseFloat(data['total_user_dollars']), before_dollars: parseFloat(data["before_dollars"]) });
                var positive_num = Math.abs($("#dollar-result").data("dollars").WorL.toFixed(2));
                var user_dollar = $("#dollar-result").data("dollars").total_dollar.toFixed(2);
                var before_dollar = $("#dollar-result").data("dollars").before_dollars.toFixed(2);
                if (data['gain_or_pain_in_dollars'] > 0) {
                    $("#win-or-lose").text("Great success!");
                    $("#photo-result").attr("src", "/static/moneybag.svg");
                    $("#dollar-result").text("You gained $" + positive_num + ", bringing your starting total from $" + before_dollar + " to $" + user_dollar + "!");
                    console.log('tada');
                    $("#popup").transition('tada')
                    $('#popup').css('display', 'inline-block !important')

                }
                else {
                    $("#win-or-lose").text("Massive failure :(");
                    $("#photo-result").attr("src", "/static/skulldollar.svg");
                    $("#dollar-result").text("You lost $" + positive_num + ", taking your starting total from $" + before_dollar + " down to $" + user_dollar);
                    $("#popup").transition('shake')

                }
            });
        };
        $("#trade-form").submit(function () {
            $("#popup").modal({
                fadeDuration: 1000
            });
        });
        $("#resubmit").click(function () {
            openModal()
        });
    })
</script>
<script src="static/sortable.min.js"></script>
<link rel="stylesheet" href="static/sortable.min.css">
<style>
    .ui.celled.table {
        border-collapse: collapse;
        margin: 25px 0;
        color: blue;
        font-size: 0.9em;
        min-width: 400px;
    }

    .hide-value {
        position: absolute !important;
        top: -9999px !important;
        left: -9999px !important;
    }

    /* Required field in search box prevents capitalisation of placeholder. */
    .search:valid {
        text-transform: uppercase;
    }
</style>
<form>
    <div class="ui left icon input">
        <input name="search" type="text" class="search" id="userInput" required="required" placeholder="Search..."
            onkeyup="filterTable()" data-com.bitwarden.browser.user-edited="yes" value={{ search or '' }}>
        <i class="search icon"></i>
    </div>
    <div class="ui checkbox">
        <input name="gain" type="checkbox" name="gain" {% if gain %}checked="checked" {% endif %}>
        <label>Gain</label>
    </div>
    <div class="ui checkbox">
        <input name="pain" type="checkbox" name="pain" {% if pain %}checked="checked" {% endif %}>
        <label>Pain</label>
    </div>
    <button type="submit" class="ui button primary">
        Filter
    </button>
    <button class="ui button">
        Reset
    </button>
</form>
<button id="try_your_luck" class="ui animated button green" tabindex="0">
    <div class="visible content">Try your luck!</div>
    <div class="hidden content">
        <i class="right arrow icon"></i>
    </div>
</button>

<table class="ui celled table sorter" id="cryptoTable">
    <thead>
        <tr>
            <th>Cryptocurrency Pair</th>
            <th>Base Asset</th>
            <th>Quote Asset</th>
            <th>Exchange Rate</th>
            <th>Price Change</th>
            <th>Percentage Change</th>
            <th>Gain/Pain</th>
        </tr>
    </thead>
    <tbody>
        {% for crypto in cryptos %}
        <tr {% if crypto.gain==1 %} style="background-color:#fcfff5" {% endif %} {% if crypto.pain==1 %}
            style="background-color:#fef5f6" {% endif %}>
            <td>{{crypto.symbol}}</td>
            <td>
                <div class="crypto-icons">
                    {% if crypto.base_asset in svg_icons %}
                    <img src="/static/icons/{{crypto.base_asset}}.svg" width="16" height="16" alt="" />
                    {% else %} <img src="/static/icons/generic.svg" width="16" height="16" alt="" />
                    {% endif %}
                    {{crypto.base_asset}}
                </div>
            </td>
            <td>
                <div class="crypto-icons">
                    {% if crypto.quote_asset in svg_icons %}
                    <img src="/static/icons/{{crypto.quote_asset}}.svg" width="16" height="16" alt="" />
                    {% else %} <img src="/static/icons/generic.svg" width="16" height="16" alt="" />
                    {% endif %}
                    {{crypto.quote_asset}}
                </div>
            </td>
            <td>{{crypto.price}}</td>
            <td>{{crypto.change}}</td>
            <td>{{crypto.percentage_change}}</td>
            {% if crypto.gain == 1 %}
            <td style=" text-align: center; vertical-align: middle;">
                <div class="hide-value">{{crypto.percentage_change}}</div><i class="icon checkmark"
                    style="color:green; visibility: visible"></i>
            </td>
            {% elif crypto.pain == 1 %}
            <td style="text-align: center; vertical-align: middle;">
                <div class="hide-value">{{crypto.percentage_change}}</div><i class="icon close"
                    style="color:crimson"></i>
            </td>
            {% else %}
            <td style="text-align: center; vertical-align: middle;">
                <div class="hide-value">{{crypto.percentage_change}}</div>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>


<div id="trade-form" class="window modal">
    <form class="ui form" id="trade-form-form">
        <h3>Try your luck!</h3>
        <div class="field">
            <label>Coin to buy: </label>
            <div class="ui fluid search selection dropdown" name="c2b" id="c2b">
                <input type="hidden" name="c2b">
                <i class="dropdown icon"></i>
                <div class="default text">Select coin to buy</div>
                <div class="menu">
                    {% for coin in set_of_base_coins %}
                    <div class="item" data-value={{coin}}>
                        {% if coin in svg_icons %}
                        <img src="/static/icons/{{coin}}.svg" width="20px" height="20px" alt="" />
                        {% else %}
                        <img src="/static/icons/generic.svg" width="20px" height="20px" alt="" />
                        {% endif %}
                        {{coin}}
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="field">
                <label>Coin to sell: </label>
                <div class="ui fluid search selection dropdown" name="c2s" id="c2s">
                    <input type="hidden" name="c2s">
                    <i class="dropdown icon"></i>
                    <div class="default text">Select coin to sell</div>
                    <div class="menu" id="c2sDrop">
                    </div>
                </div>
                <div class="field">
                    <p><label>Amount to sell: </label><input placeholder="" name="a2s" type="text" id="amount">
                    </p>
                </div>
                <p>
                    <a href="close-modal" rel="modal:close">
                        <input type="submit" value="Nope" class="ui black deny button" style="margin-right:20px">
                    </a>
                    <input type="submit" value="Submit trade" class="ui positive right labeled icon button">
                </p>
                <div class="ui error message"></div>
    </form>
</div>

<div id="popup" class="modal" style="vertical-align: middle;">
    <div class="image content">
        <div class="ui medium image">
            <img id="photo-result">
        </div>
        <div class="description">
            <div id="win-or-lose" class="ui header" style="margin-top:5px"></div>
            <p id="dollar-result" style="margin-top: 15px; font-size: 16px;"></p>
            <p style="margin-bottom:15px; font-size:18px">Try again?</p>
        </div>
    </div>
    <div class="actions">
        <a href="close-modal" rel="modal:close">
            <div class="ui black deny button">
                Nope
            </div>
        </a>
        <div id="resubmit" class="ui positive right labeled icon button">
            Sure...
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

<script>
    function filterTable() {
        // Declare variables
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("userInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("cryptoTable");
        tr = table.getElementsByTagName("tr");

        // Loop through all table rows, and hide those who don't match the search query
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[0];
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>

{% endblock %}